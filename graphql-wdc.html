<!DOCTYPE html>
<html>
<head>
    <title>Politigraph GraphQL Connector</title>
    <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.latest.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 600px; }
        button { 
            padding: 10px 20px; 
            background: #0070c0; 
            color: white; 
            border: none; 
            cursor: pointer; 
            margin: 10px 0;
        }
        button:hover { background: #005a9e; }
        .query-builder { margin: 20px 0; }
        textarea { 
            width: 100%; 
            height: 150px; 
            margin: 10px 0;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Politigraph GraphQL Connector</h1>
        
        <div class="query-builder">
            <h3>GraphQL Query</h3>
            <textarea id="graphqlQuery">
{
  politicians {
    id
    name
    party
    position
    province
  }
}</textarea>
            <button id="submitButton">Get Data</button>
        </div>
        
        <div id="status"></div>
    </div>

    <script>
        (function() {
    // สร้าง connector
    var myConnector = tableau.makeConnector();

    // กำหนด schema
    myConnector.getSchema = function(schemaCallback) {
        // กำหนดคอลัมน์ข้อมูล - ปรับเปลี่ยนตามข้อมูลจริงจาก API
        var cols = [
            {
                id: "id",
                alias: "ID",
                dataType: tableau.dataTypeEnum.string
            },
            {
                id: "name",
                alias: "ชื่อ",
                dataType: tableau.dataTypeEnum.string
            },
            {
                id: "party",
                alias: "พรรค",
                dataType: tableau.dataTypeEnum.string
            },
            {
                id: "position",
                alias: "ตำแหน่ง",
                dataType: tableau.dataTypeEnum.string
            },
            {
                id: "province",
                alias: "จังหวัด",
                dataType: tableau.dataTypeEnum.string
            },
            {
                id: "age",
                alias: "อายุ",
                dataType: tableau.dataTypeEnum.int
            },
            {
                id: "education",
                alias: "การศึกษา",
                dataType: tableau.dataTypeEnum.string
            }
        ];
        
        var tableSchema = {
            id: "PolitigraphData",
            alias: "ข้อมูลการเมืองจาก Politigraph",
            columns: cols
        };
        
        schemaCallback([tableSchema]);
    };

    // ฟังก์ชันดึงข้อมูล
    myConnector.getData = function(table, doneCallback) {
        var graphqlQuery = document.getElementById('graphqlQuery').value;
        
        // ส่ง request ไปยัง GraphQL API
        $.ajax({
            url: "https://politigraph.wevis.info/graphql",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                query: graphqlQuery
            }),
            success: function(response) {
                console.log("Response received:", response);
                
                if (response.errors) {
                    tableau.log("GraphQL Errors: " + JSON.stringify(response.errors));
                    document.getElementById('status').innerHTML = 
                        '<div style="color: red;">Error: ' + response.errors[0].message + '</div>';
                    return;
                }
                
                // แปลงข้อมูลให้เหมาะสมกับ Tableau
                var tableData = [];
                
                // ตรวจสอบและประมวลผลข้อมูลตามโครงสร้าง response
                if (response.data.politicians) {
                    response.data.politicians.forEach(function(item) {
                        tableData.push({
                            "id": item.id || "",
                            "name": item.name || "",
                            "party": item.party || "",
                            "position": item.position || "",
                            "province": item.province || "",
                            "age": item.age || null,
                            "education": item.education || ""
                        });
                    });
                } else if (response.data.politicalParties) {
                    response.data.politicalParties.forEach(function(item) {
                        tableData.push({
                            "id": item.id || "",
                            "name": item.name || "",
                            "party": item.name || "", // ใช้ชื่อพรรคในฟิลด์ party
                            "position": "พรรค",
                            "province": item.headquarters || "",
                            "age": item.foundedYear ? new Date().getFullYear() - item.foundedYear : null,
                            "education": ""
                        });
                    });
                }
                
                table.appendRows(tableData);
                document.getElementById('status').innerHTML = 
                    '<div style="color: green;">Success! Loaded ' + tableData.length + ' rows</div>';
                doneCallback();
            },
            error: function(xhr, status, error) {
                tableau.log("AJAX Error: " + error);
                document.getElementById('status').innerHTML = 
                    '<div style="color: red;">Connection Error: ' + error + '</div>';
                doneCallback();
            }
        });
    };

    // ลงทะเบียน connector เมื่อหน้าเว็บโหลดเสร็จ
    $(document).ready(function() {
        $("#submitButton").click(function() {
            tableau.connectionName = "Politigraph Data";
            tableau.submit();
        });
        
        tableau.registerConnector(myConnector);
    });
})();
    </script>
</body>
</html>
